---
title: "Assignment2"
author: "Margaux Sleckman"
date: "May 15, 2019"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

connect Rmd SQL chunk to SQLite database

```{r }

library(DBI)
library(tidyverse)
library(dplyr)
if(!require(readr)) install.packages("readr")
if(!require(skimr)) install.packages("skimr")
library(stringr)

library("RSQLite")

parcels_db <- dbConnect(RSQLite::SQLite(), dbname = "parcels.db")
parcels_db

UseCodes<-read_delim("UseCodes.csv", delim = "|", na = "No Description Available",
                     col_types = cols_only(UseCode = "n", CodeDesc = "c"))

parcels <- read_delim("parcels.csv", delim = "|")

```
```{r copy_data_to_db}

library(dbplyr)

dbWriteTable(parcels_db, "parcels", parcels, row.names = T, overwrite = T)
dbWriteTable(parcels_db, "UseCodes", UseCodes, row.names = T, overwrite = T)

db_list_tables(parcels_db)


```


```{sql connection=parcels_db}

SELECT sql AS schema FROM sqlite_master
```

```{sql connection=parcels_db}

SELECT APN, Home_address1, UseCode FROM parcels;
```

```{sql connection=parcels_db}

SELECT parcels.usecode, UseCodes.CodeDesc, count(parcels.UseCode) AS "Count"
FROM parcels 
JOIN UseCodes ON parcels.UseCode = UseCodes.UseCode
Group By parcels.UseCode
ORDER BY Count DESC
Limit 10;

```

#### 2. Acres for the whole agri. preserves 
  We summed the acres for only agri. preserve type land 
  We assume agri preserve is everything non-NA in agri preserve varaible

```{sql connection=parcels_db}

Select sum(parcels.Acreage) As "Total acreage" 
From parcels
where parcels.AgPres IS NOT NULL;



```

```{sql connection = parcels_db}

Select (sum(parcels.Net_AV))/(sum(parcels.Acreage)) AS "Mean Net Assessed Value"
FROM parcels

```

```{sql connection=parcels_db}

Select Top "10" parcels.UseCode 
From parcels;

```

#### 4. what is the total net assessed value of all non-taxable parcels 

```{sql connection=parcels_db}


Select sum(parcels.Net_AV) As "Total Net_AV for Non-taxable" 
From parcels
where parcels.NonTaxCode IS NOT NULL;


```

#### 5. 10 largest property holders, by acreage?

We assume use mailing address of tax statements as a proxy for the parcel owner

```{sql connection = parcels_db}


SELECT parcels.Mail_Address1, parcels.Mail_Address2, Acreage, sum(parcels.Acreage) AS "PropertyAcreage"
FROM parcels 
Where parcels.Mail_Address1 IS NOT NULL AND parcels.Mail_Address2 IS NOT NULL AND parcels.Acreage IS NOT NULL
Group By parcels.Mail_Address1, parcels.Mail_Address2
ORDER BY PropertyAcreage DESC
Limit 10;


```

```{sql connection=parcels_db}

SELECT parcels.Mail_Address1, parcels.Mail_Address2, parcels.Net_AV, sum(parcels.Net_AV) AS "PropertyNet_AV"
FROM parcels 
Where parcels.Mail_Address1 IS NOT NULL AND parcels.Mail_Address2 IS NOT NULL AND parcels.Net_AV IS NOT NULL
Group By parcels.Mail_Address1, parcels.Mail_Address2
ORDER BY PropertyNet_AV DESC
Limit 10;



```
```{r}

dbDisconnect(parcels_db)

```
