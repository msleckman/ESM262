---
title: "ESM232-Assignment1"
author: "Margaux Sleckman"
date: "April 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r libs}

library(tidyverse)
library(dplyr)
if(!require(readr)) install.packages("readr")
if(!require(skimr)) install.packages("skimr")

```

```{r read}

#---read in file---# 

# parcels <- read_csv("Assignment1/Santa_Barbara_County_parcels_2011.csv")
# View(head(parcels, 50))

path <- "C:/github/ESM262/ESM262/"

parcels_raw <- read_csv(paste0(path, "Assignment1/Santa_Barbara_County_parcels_2011.csv"),
                               col_types =  cols(.default = col_character())
                        )

names(parcels_raw)
# View(head(parcels_raw, 50))

```

```{r subset_check_clean}

#---Parse Data ---#
parcel_select <- select(parcels_raw, 
                        APN, 
                        Home_address1 = Situs1,
                        Home_adress2 = Situs2,
                        Acreage, 
                        UseCode, 
                        NonTaxCode, 
                        AgPres, 
                        Land_Value = LandValue,
                        Net_Impr, 
                        Net_AV, 
                        Mail_Address1 = M_Address1, 
                        Mail_Address2 = M_Address2)

dim(parcel_select)
str(parcel_select)
skim(parcel_select)

parcels <- as_tibble(parcel_select)
head(parcels)
# Lets look at the data now that its 

lapply(parcels, class)
anyNA(lapply(parcels, unique))

### defined as type character : 
# 1. City_address --> makes sense there are words
# 2. Home_address --> makes sense there are words 
# 3. M_Address1 --> address with words 
# 4. M_address2 --> address with words 
# 5. nontaxcode --> letter plus numbers 
# 6. usecode --> letters plus numbers 
### Defined as numeric: 
# 6. Acreage --> number, unit ... 
# 7. Land_Value --> number, unit $$ 
# 8. Net_AV --> number, idk what unit 
# 9. Net_Impr --> number, idk what unit

skim(as.tibble(parcels[,11-12]))
skim(as.tibble(parcels[,6:10]))
skim(as.tibble(parcels[,1:5]))

## seems clean 

```

```{r write}

#write.csv of parcels df 


write_csv(parcel_select, paste0(path, "/Assignment1/parcel_select.csv"))

```


## Analysis Questions

###1. 10 most-frequently-occuring land uses
```{r 1}

# 10 most frequ.occuring land uses 
# loadl in package
UseCodes<-read_delim("UseCodes.csv", delim = "|", na = "No Description Available",
                     col_types = cols_only(UseCode = "c", CodeDesc = "c")
                     )

UseCodes[1430,]

#prepare for join
View(head(UseCodes, 40))
length(unique(UseCodes))
length(unique(parcels_raw$UseCode))
names(UseCodes)
names(parcels)
length(unique(UseCodes$CodeDesc))
length(unique(UseCodes$UseCode)) #1430
length(unique(parcels$UseCode)) #591

# there are only 591/1430 different unique usecodes used in SB county. 

head(as.tibble(parcels))



# Join
class(parcels$UseCode)
class(UseCodes$UseCode)

UseCodes$UseCode <- as.character(UseCodes$UseCode)

parcels <- left_join(x = parcels, y = UseCodes, by = 'UseCode') 
class(parcels$UseCode)  

# View(parcels)
# unique(parcels$UseCode)
# str(parcels)
# unique(parcels$UseCode)

## Solution ##
parcels_2 <- parcels %>% 
  group_by(UseCode, CodeDesc) %>% 
  tally() %>% 
  arrange(-n) %>%
  head(10)

## alternative solution 
parcels_3 <- parcels %>% 
  count(UseCode, CodeDesc) %>% 
  arrange(-n) %>% 
  head(10)


# consider renameing the tally column n 
  
```

#### 2. Acres for the whole agri. preserves 
 * sum the acres for only agri. preserve type land 

```{r }
View(parcels)

library(stringr)

parcels_acreage <- parcels %>% 
  filter(str_detect(CodeDesc, "Ag preserve")) 

Sum_acres <- sum(as.numeric(parcels_acreage$Acreage))
Sum_acres

```

#### 3. Mean net assessed value per acre of the entire county 

```{r }

# Net mean assess value

mean_Net_AV <- mean(as.numeric(parcels$Net_AV))

```


#### 4. what is the total net assessed value of all non-taxable parcels 
# what are the non taxable parcels?

```{r nontaxableparcels}


```


#### 5. 10 largest property holders, by acreage?
  --> use mailing address of tax statements as a proxy for the parcel owner
  --> Question: do we remove NA mailing addresses ?
  
```{r top_prop_holders}

parcels_top_acreage <- parcels %>% 
  filter(!is.na(Mail_Address1)) %>% 
  group_by(Mail_Address1, Mail_Address2) %>% 
  summarise(property = sum(as.numeric(Acreage))) %>% 
  arrange(-property) %>% 
  head(10)
  
arrange(-as.numeric(Acreage)) %>% 
  head(10)
View(parcels_top_acreage)

  
```
  
#### 6. 10 largest property holder, by net assessed value?



